name: porthttpdirbscan
desc: Run directory scan based on http output

report:
  final:
    - "{{Output}}/directory/beautify-ip-{{Workspace}}.txt"
    - "{{Storages}}/paths/{{Workspace}}/paths-ip-{{Workspace}}.txt"
    - "{{Storages}}/paths/{{Workspace}}/beautify-ip-{{Workspace}}.csv"

params:
  - httpFile: "{{Output}}/portscan/{{Workspace}}-http.txt"
  - wordlists: "{{Data}}/wordlists/content/big.txt"
  - dlimit: '50000'
  - recursion: '0'
  - chan: '#mics'
  - ffThreads: '{{ threads }}' # threads for single site
  - dirbThreads: '{{ threads / 3 }}'
  - ffTimeout: "1h"
  - defaultUA: "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36 Edg/122.1.0.0"

pre_run:
  - CreateFolder("{{Storages}}/paths/{{Workspace}}")
  - CreateFolder("{{Output}}/directory")

steps:
  # check wildcard before brute force dns. We don't want tons of garbage here
  - conditions:
      - "FileLength('{{httpFile}}') > {{dlimit}}"
    scripts:
      - ErrPrintf("Filter", "Got input file greater than {{dlimit}} line")
      - Exit(1)

  - required:
      - "{{Binaries}}/ffuf"
      - "{{httpFile}}"
    source: "{{httpFile}}"
    threads: '{{dirbThreads}}'
    commands:
      - "timeout -k 1m {{ffTimeout}} {{Binaries}}/ffuf -s -t {{ffThreads}} -noninteractive -ac -acs advanced -timeout 12 -H '{{defaultUA}}' -se -D -fc '429,404,400' -e 'asp,aspx,aspx~,asp~,py,py~,rb,rb~,php,php~,bak,bkp,cache,cgi,conf,csv,html,inc,js,json,jsp,jsp~,log,old,txt,zip,7z' -json -w {{wordlists}}:FUZZ -u [[.line]]/FUZZ > {{Output}}/directory/raw-ip-[[._id_]].json"
  - scripts:
      - ExecCmd("cat {{Output}}/directory/raw-ip-*.json | jq -r '[.url,(.status|tostring),(.length|tostring),(.words|tostring),(.lines|tostring),.hash,.redirectlocation] | join(\",\")' > {{Output}}/directory/beautify-ip-{{Workspace}}.csv")
      - ExecCmd("rm -rf {{Output}}/directory/raw-ip-*.json")
      - ExecCmd("cat {{Output}}/directory/beautify-ip-{{Workspace}}.csv |  {{Binaries}}/csvtk pretty --no-header-row -I -s ' | ' -W 75 > {{Output}}/directory/beautify-ip-{{Workspace}}.txt")
      - ExecCmd("cat {{Storages}}/paths/{{Workspace}}/paths-ip-{{Workspace}}.csv | {{Binaries}}/csvtk uniq -f 4 -I | {{Binaries}}/csvtk pretty --no-header-row -I -s ' | ' -W 75 > {{Storages}}/paths/{{Workspace}}/beautify-ip-{{Workspace}}.txt")
      - TeleMessByFile("#dirb", "{{Output}}/directory/beautify-ip-{{Workspace}}.txt")
      - Cat("{{Output}}/directory/beautify-ip-{{Workspace}}.txt")
      - ExecCmd("cp {{Output}}/directory/beautify-ip-{{Workspace}}.txt {{Output}}/directory/unique-beautify-ip-{{Workspace}}.txt")

post_run:
  # - TotalDirb("{{Output}}/directory/beautify-{{Workspace}}.txt")
  # - GenMarkdownReport("{{Data}}/markdown/general-template.md", "{{Output}}/summary.html")